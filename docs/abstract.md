### **ç®€ä»‹** ###

paozhuæ˜¯ä¸€æ¬¾C++ Webå¼€å‘æ¡†æ¶ï¼Œå†…ç½®HTTP/1 HTTP/2 ORM,å¯ä»¥è½»æ¾ä¼˜é›…å†™Webç¨‹åºï¼Œæ‰“ç ´ä»¥å¾€C++å†™Webç¨‹åºä¸æ–¹ä¾¿é—®é¢˜ã€‚

paozhuç¼–å†™äº†Webå¼€å‘åº•å±‚è®¾æ–½ï¼Œæ¯”å¦‚å¤šåŸŸåç»‘å®šã€SSLè¯ä¹¦ç®¡ç†ã€Cookieã€Sessionã€HTMLè¡¨å•ç®¡ç† ã€URLå¤„ç†ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€HttpClientå®¢æˆ·ç«¯ã€æ•°æ®åº“è¿æ¥ORMã€WebSocketã€æ—¥å¿—ï¼Œæ¶µç›–Webå¼€å‘åŸºç¡€ã€‚

æ¡†æ¶åŸºäºC++20ä¸ºåŸºç¡€ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨æ–°æ ‡å‡†ï¼Œç¼–è¯‘å™¨æ”¯æŒå®Œæ•´ï¼Œä¸€ä¸ªæ˜¯è®©ä»£ç æ›´åŠ ç°ä»£åŒ–ï¼Œæ¡†æ¶å¼€å¯äº†ASANå’Œæ‰€æœ‰é”™è¯¯æç¤ºï¼Œæ–¹ä¾¿å¼€å‘é˜¶æ®µå‘ç°é—®é¢˜ï¼Œä¹Ÿå¯ä»¥è¿è¡Œæ—¶å€™ç»“åˆcoredumpctlå·¥å…·ï¼ŒæŸ¥çœ‹å„ä¸ªçº¿ç¨‹å†…å­˜æ ˆã€‚é…åˆæ™ºèƒ½æŒ‡é’ˆåŸºæœ¬æœç»å†…å­˜æ³„éœ²å’Œè¶Šç•Œé—®é¢˜ï¼Œæ¡†æ¶ç›®å‰åŸºæœ¬æ²¡æœ‰ç¢°åˆ°å†…å­˜æ³„éœ²æˆ–å´©æºƒæƒ…å†µã€‚

paozhuä½¿ç”¨C++ï¼Œä¸»è¦æ˜¯è€ƒè™‘æ¥å…¥å¤§æ¨¡å‹ï¼ˆCUDAã€æ–‡ä»¶å­˜å‚¨ã€ç½‘ç»œã€å†…å­˜æ“ä½œï¼‰ã€å¯¹æ¯”ä¸‹GO JAVA RUSTï¼Œéƒ½ä¸æ˜¯å¾ˆå®Œç¾ï¼ŒC++ä¹Ÿä¸å®Œç¾ï¼ŒRUSTè¯­æ³•ä¸å¥½çœ‹ã€GOç®€å•ä½†æ˜¯åˆ°æ¨¡å‹ç­‰æ²¡æœ‰å¾ˆæ·±åšæ–‡åŒ–ã€‚ç›®å‰ç»éªŒæ˜¯ASANå’Œcoredumpctlä¸¤ä¸ªå·¥å…·ä¹Ÿèƒ½ä¿è¯C++è´¨é‡ï¼Œæ–°ç¼–è¯‘å™¨ä¹Ÿèƒ½æç¤ºä¸€éƒ¨åˆ†ã€‚

### paozhuç‰¹è‰² ###

1. æ”¯æŒHTTP2ã€‚
1. å†…ç½®ORMï¼ˆè‡ªç ”MySQLåè®®ï¼‰ï¼Œæ”¯æŒåç¨‹æ¨¡å¼ã€‚
1. å¤šåŸŸåç®¡ç†ã€SAASæ¨¡å¼æ”¯æŒã€‚
1. IOçº¿ç¨‹å’Œä¸šåŠ¡çº¿ç¨‹åˆ†å¼€ã€‚
1. å†…ç½®å¾®å‹å¯¹è±¡ï¼ŒJSONå¯¼å…¥å¯¼å‡ºï¼Œç±»ä¼¼è„šæœ¬è¯­è¨€ä¸­å˜é‡ã€‚
1. å†…ç½®FastCGI æ”¯æŒPHP

### paozhuéœ€æ±‚ç¯å¢ƒ ###

paozhuæ”¯æŒ`MacOS`ã€`Linux`ã€`Windows`ç³»ç»Ÿã€‚

ä¾èµ–ç¬¬ä¸‰æ–¹å¼€å‘åŒ…

`OpenSSL` `Zlib` `Brotli` `ASIO`

å¯é€‰ç¬¬ä¸‰æ–¹åŒ…  

`GD` `qrencode`


æ¡†æ¶åŸºäºC++20ä»¥ä¸Šï¼Œç¡®ä¿ä½ çš„ç³»ç»Ÿæ”¯æŒçš„ç¼–è¯‘å™¨æ”¯æŒC++20ã€‚

- `MacOS` å¿…é¡»`MacOS 11 BigSur`ä»¥ä¸Šï¼Œæœ€å¥½æ˜¯ `MacOS 14 Sonoma`  
- `Ubuntu` å¿…é¡»æ˜¯22.04ä»¥ä¸Š  
- `RockyLinux` `AlmaLinux` å¿…é¡»æ˜¯9.1ä»¥ä¸Š  
- `Windows` å¿…é¡»æ˜¯Win10 ç¼–è¯‘å™¨æœ€å¥½19.25ä»¥ä¸Šã€‚

  
### paozhuå®‰è£… ###

- MacOSå®‰è£… å‚è€ƒ 
- Ubuntuå®‰è£… å‚è€ƒ 
- RockyLinux AlmaLinux å®‰è£… å‚è€ƒ  
- Windows å®‰è£… å‚è€ƒ  

### paozhué…ç½® ###

paozhué…ç½®æ–‡ä»¶åœ¨`conf/server.conf`

å¯ä»¥å…ˆäº†è§£å‡ ä¸ªå˜é‡è®©é¡¹ç›®è¿è¡Œèµ·æ¥ã€‚


```
[default]
threadmax=1024
threadmin=5
httpport=80
httpsport=443
cothreadnum=8 ;Coroutines run on thread num

http2_enable=1
debug_enable=1
deamon_enable=0
mainhost=www.869869.com
certificate_chain_file=www.869869.com.pem
private_key_file=www.869869.com.key
tmp_dh_file=dh4096.pem
reboot_password=e10adc3949ba59abbe56e057f20f883e ;md5(md5("123456")+"rand_char"+md5("123456"))
reboot_cron =d180h5 ;MDSW+Hhours reboot process M month D day S season (1 4 7 10) W week  
clean_cron  =m5t600 ;5-minute interval clean 600 seconds ago inactive connection
links_restart_process =n9998877ts1te5 ;More than 15000 connections, restart the process from 1:00 am to 5:00 am
session_type=1 ;session save type 0.file 1.memory 2.redis 3.memcache 4.reserve
static_file_compress_cache=1 ;1 enable, Cache static file compress(gzip,br) content to cache directory 
modelspath=/Users/hzq/paozhu/models
serverpath=/Users/hzq/paozhu
viewpath=/Users/hzq/paozhu/view
viewsopath=/Users/hzq/paozhu/module/view

controlpath=/Users/hzq/paozhu/controller
controlsopath=/Users/hzq/paozhu/module/controller

temppath=/Users/hzq/paozhu/temp
logpath=/Users/hzq/paozhu/log
wwwpath=/Users/hzq/paozhu/www/default
pluginspath=/Users/hzq/paozhu/plugins
libspath=/Users/hzq/paozhu/libs
directorylist=1
index=index.html
;usehtmlcache=1
;usehtmlcachetime=3600
staticfile_cache_num=0 ;0 not cache, min 10 begin  
rewrite_404=0   ;1 file 2 action url path
rewrite_404_action=index.html
method_pre=
method_after=
show_visitinfo=0
upload_max_size=16777216
siteid=1
groupid=0
alias_domain=
init_func=
[www.869869.com]
wwwpath=/Users/hzq/paozhu/www/default
http2_enable=1
;rewrite_404=1
;rewrite_404_action=index.html|psy/index.html|exam/index.html
;controlsopath=/Users/hzq/paozhu/docs/controller
static_pre=downloadfileauth|upload
method_pre= ;api/dev/hostcors
method_after=
isuse_php=0
rewrite_php=/Users/hzq/www/mpdftest|index.php
fastcgi_host=127.0.0.1 ;/run/php/php8.1-fpm.sock
fastcgi_port=9000
upload_max_size=16777216
siteid=1
groupid=0
alias_domain=
init_func=
```

```
threadmax=1024  æœ€å¤§ä¸šåŠ¡çº¿ç¨‹æ•°
threadmin=5		æœ€å°ä¸šåŠ¡çº¿ç¨‹æ•°
httpport=80	    æœåŠ¡å™¨å€¾å¬ç«¯å£ 
httpsport=443   sslæœåŠ¡å™¨å€¾å¬ç«¯å£ 
cothreadnum=8 ;Coroutines run on thread num IOåç¨‹ä½¿ç”¨çº¿ç¨‹æ± æ•°é‡
```

`http2_enable=1` æ˜¯å¦å¯ç”¨http2ï¼Œå¯ä»¥æ¯ä¸ªåŸŸåæœ‰è‡ªå·±çš„è®¾ç½®

sslè¯ä¹¦æ–‡ä»¶ï¼Œç”³è¯·æˆåŠŸåæ”¾åœ¨confç›®å½•ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦åœ¨`/var/local/etc/paozhu`æ”¾ä¸€ä»½

```
mainhost=www.869869.com
certificate_chain_file=www.869869.com.pem
private_key_file=www.869869.com.key
```

`reboot_cron` è‡ªåŠ¨é‡å¯è¿›ç¨‹å‘¨æœŸå¤©D å‘¨W æœˆM å­£èŠ‚S  hæ—¶é—´å°æ—¶ 180å¤©å‡Œæ™¨5ç‚¹é‡å¯è¿›ç¨‹
`links_restart_process` å¦‚æœè¾¾åˆ°è¿æ¥æ•°ä¹Ÿå¯ä»¥é‡å¯nåé¢è¿æ¥æ•°ï¼Œ
ts å¼€å§‹æ—¶æ®µ teç»“æŸæ—¶æ®µï¼Œå¦‚æœè¿™æ®µæ—¶é—´ç©ºé—²å°±ä¼šé‡å¯ã€‚


```
reboot_cron =d180h5 ;MDSW+Hhours reboot process M month D day S season (1 4 7 10) W week  
clean_cron  =m5t600 ;5-minute interval clean 600 seconds ago inactive connection
links_restart_process =n9998877ts1te5 ;More than 15000 connections, restart the process from 1:00 am to 5:00 am
```

`directorylist=1` æ˜¾ç¤ºç›®å½•ï¼Œå¦‚æœè¯·æ±‚é™æ€æ–‡ä»¶æ˜¯ç›®å½•åï¼Œç›®å½•ä¸‹ä¹Ÿæ²¡æœ‰index.htmlæ–‡ä»¶ä¼šæ˜¾ç¤ºç›®å½•åˆ—è¡¨ã€‚
ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸º0.

`wwwpath=/Users/hzq/paozhu/www/default` `/Users/hzq/paozhu`å»ºè®®æ¢æˆä½ çš„å½“å‰ç›®å½•åç§°,
é¡¹ç›®ä¸‹`www/default`ï¼Œæ˜¯é™æ€æ–‡ä»¶ç›®å½•ï¼Œå¦‚æœæ˜¯å¤šåŸŸåå»ºè®®åˆ›å»º`www/domain.com`è¿™ä¸ªè®¾ç½®æ˜¯ä¸ºSAASæœåŠ¡çš„ã€‚


`upload_max_size=16777216` ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤æ˜¯16M

ä¸‹é¢å‡ ä¸ªæ˜¯SAASè®¾ç½®å¯ä»¥å…ˆä¸ç®¡

```
siteid=1
groupid=0
alias_domain=
init_func=
```

åˆå­¦è€…åªè¦å…³æ³¨ `httpport` `httpsport` `wwwpath`è®¾ç½®æ˜¯å¦æ­£ç¡®ã€‚


### paozhuå…¥é—¨ ###

#### Hello, World ä¾‹å­

```C++

//@urlpath(null,plaintext)
asio::awaitable<std::string> techempowerplaintext(std::shared_ptr<httppeer> peer)
{
    peer->type("text/plain; charset=UTF-8");
    peer->set_header("Date", get_gmttime());
    peer->output = "Hello, World!";
    co_return "";
}

```


### æ³¨è§£åŸç†

æ‰€æœ‰æ³¨è§£å‡½æ•°å¿…é¡»æ”¾åœ¨ `controller/src` ç›®å½•ä¸‹

ç¼–è¯‘æ—¶å€™ä½¿ç”¨CMake Hookï¼Œå…ˆç¼–è¯‘ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„æ³¨è§£å¤„ç†ç¨‹åºï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªç¨‹åºå¤„ç†  `controller/src` 
ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œæå–`//@urlpath(null,plaintext)`æ ¼å¼çš„å‡½æ•°ï¼Œç„¶ååˆ›å»ºç›¸åº”çš„å¤´æ–‡ä»¶ï¼Œç„¶åç”Ÿæˆ
æ³¨è§£å‡½æ•°ï¼Œä¿å­˜æ˜ å°„å‡½æ•°åˆ° `common/autocontrolmethod.hpp` æ–‡ä»¶ã€‚

æ˜¯ä¸æ˜¯å¾ˆæœ‰Java Sprint Bootå‘³é“ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ¯•ç«Ÿä¼˜é›…å†™URLå’Œå‡½æ•°æ˜ å°„å…³ç³»ã€‚


### æ³¨è§£ä»‹ç»

`//@urlpath(null,plaintext)` ä¸ºæ³¨è§£å‡½æ•°ï¼Œä¸urlæ˜ å°„ï¼Œæ¯”å¦‚ http://localhost/plaintext ä¼šè®¿é—®åˆ°`plaintext` çš„æ³¨è§£å‡½æ•°ã€‚  

nullè¡¨ç¤ºè®¿é—®plaintextä¹‹å‰å¿…é¡»å…ˆæ‰§è¡Œçš„æ³¨è§£å‡½æ•°ï¼Œä¾‹å¦‚ï¼šå¸¦æƒé™çš„åå°ï¼Œéœ€è¦éªŒè¯æ˜¯å¦ç™»å½•

`//@urlpath(islogin,plaintext)` è¿™æ ·å¿…é¡»å…ˆæ‰§è¡Œ`islogin`çš„æ³¨è§£ï¼Œè¿”å›`OK`è¡¨ç¤ºæˆåŠŸã€‚

```C++
//@urlpath(null, islogin)
asio::awaitable<std::string> checklogin(std::shared_ptr<httppeer> peer)
{
    httppeer &client = peer->get_peer();

	if(peer->session["userid"].to_int()>0)
	{
		 co_return "ok";
	} 

	client << "You must login";

    co_return "";
}
```

`asio::awaitable<std::string>` åç¨‹æ³¨è§£å‡½æ•°è¡¨ç¤ºé‡Œé¢ä»£ç ä¸èµ°ä¸šåŠ¡çº¿ç¨‹ï¼Œ
å¦‚æœç¹é‡è®¡ç®—æœ€å¥½ä½¿ç”¨æ™®é€šå‡½æ•°ï¼Œè¿™æ ·èµ°ä¸šåŠ¡çº¿ç¨‹å¤„ç†ï¼Œä¸ä¼šå¡IOçº¿ç¨‹ã€‚

`peer->session["userid"]` è¡¨ç¤ºå–å¾—`session`å†…å®¹ï¼Œå¯ä»¥åœ¨ç™»å½•æˆåŠŸåä¿å­˜è¿›å»ã€‚

`client << "You must login";` æ˜¯é‡è½½äº†`<<`è¿ç®—ç¬¦,çœŸå®å†…å®¹æ˜¯ä¿å­˜åœ¨`peer->output`ã€‚

`co_return "";` æ˜¯åç¨‹è¿”å›ç»“æœï¼Œè¯·æ³¨æ„å’Œæ™®é€šå‡½æ•°åŒºåˆ«ï¼Œä¸çŸ¥é“æœ€å¥½è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚

ä¸‹é¢æ˜¯æ™®é€šæ³¨å†Œå‡½æ•°,æ³¨æ„è¿”å›å€¼ï¼Œè¡¨ç¤ºèµ°ä¸šåŠ¡çº¿ç¨‹æ± ï¼Œå°±æ˜¯ä¸€ä¸ªè¿æ¥åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œç»å…¸åº”ç”¨ã€‚

å»ºè®®æœ‰è´Ÿè½½è®¡ç®—æœ€å¥½ä½¿ç”¨è¿™ç§æ™®é€šå‡½æ•°ï¼Œä¸ç„¶å¤§é‡è®¡ç®—å¯èƒ½å½±å“å¹¶å‘é‡ï¼Œæ˜¯æœ‰å¯èƒ½ï¼Œå¦‚æœåªæ˜¯CRUDä¸šåŠ¡
ç”¨é‚£ç§æ–¹å¼åº”è¯¥é—®é¢˜ä¸å¤§ï¼Œç”¨åç¨‹å°±ä¸è¦ä½¿ç”¨ `std::this_thread::sleep_for(std::chrono::microseconds(1000));`
è¿™ç§ä»£ç ã€‚


```C++
//@urlpath(null,hello)
std::string testhello(std::shared_ptr<httppeer> peer)
{
    httppeer &client = peer->get_peer();
    client << " Hello world! ğŸ§¨ Paozhu c++ web framework ";

    return "";
}

```

æ›´å¤šä»£ç ä½¿ç”¨æ¡ˆä¾‹è¯·å‚è€ƒ `controller/src` ç›®å½•ä¸‹çš„ä¾‹å­


### å†…ç½®å¾®å‹å¯¹è±¡ä»‹ç»


```C++
http::obj_val hval;
hval["aaa"]=3344;
hval["bbb"]="1234567890";

std::cout<<"ll:"<<hval["aaa"].to_int()<<std::endl;
std::cout<<"vv:|"<<static_cast<int>(hval["bbb"].get_type())<<"|"<<std::endl;
if(hval["bbb"].is_string())
{
    std::cout<<"str:"<<hval["bbb"].to_string()<<std::endl;
    std::cout<<"str:"<<hval["bbb"].str_view()<<std::endl;
    std::cout<<"str:"<<hval["bbb"].str_view(2,5)<<std::endl;
}

http::obj_val nval;
nval.from_json("{\"bba\":[[[111,222],[333,444],[555,666]],[[777,888],[999,1111],[2222,3333]],[[4444,5555],[6666,7777],[8888,9999]]]}");

std::cout<<"json out:"<<nval.to_json()<<std::endl;

std::string bbb=nval.to_json();
http::obj_val pval;
pval.from_json(bbb);
```

`http::obj_val` æ˜¯æ¡†æ¶å†…ç½®ä¸€ä¸ªå¾®å‹å¯¹è±¡ï¼Œå¯ä»¥å¯¼å…¥`from_json`å’Œå¯¼å‡º`to_json` `JSON`å¯¹è±¡è½¬æ¢ã€‚

æ˜¯ä¸æ˜¯æœ‰è„šæœ¬è¯­è¨€å‘³é“ï¼Œå¯ä»¥ä¿å­˜æ•°å€¼å’Œå­—ç¬¦ä¸²ï¼Œè€Œä¸”å¯ä»¥ä¿å­˜æ ‘å½¢ç»“æ„ã€‚

ä¸€ä¸ª`http::obj_val`æ˜¯16ä¸ªå­—èŠ‚å¤§å°ï¼Œå¦‚æœæ˜¯`KV`å¯¹è±¡è¦64å¤§å°ã€‚

`hval["aaa"]` å°±æ˜¯`KV`å¯¹è±¡ã€‚

`http::obj_val` å¯¹è±¡å†…ç½®æ–¹æ³•


- `set_array()` è®¾ç½®ä¸ºæ•°ç»„ å¯ä»¥ä½¿ç”¨push(v)
- `set_obj()` è®¾ç½®ä¸ºå¯¹è±¡KV å¯ä»¥ä½¿ç”¨push(k,v)æˆ–obj[key]=valueæ–¹å¼
- `set_object()` è®¾ç½®ä¸ºå¯¹è±¡KV å¯ä»¥ä½¿ç”¨push(k,v)æˆ–obj[key]=valueæ–¹å¼
 
#### åˆ¤æ–­å¯¹è±¡å±æ€§

- `is_array()` æ˜¯å¦æ˜¯æ•°ç»„
- `is_obj()`	æ˜¯å¦æ˜¯å¯¹è±¡
- `is_object()` æ˜¯å¦æ˜¯å¯¹è±¡
- `is_string()` æ˜¯å¦æ˜¯å­—ç¬¦ä¸²
- `is_number()` æ˜¯å¦æ•°å­—

#### å…¸å‹ä½¿ç”¨æ–¹å¼å’ŒHTMLæ¨¡æ¿ä½¿ç”¨

```C++
        client.val["list"].set_array();
        obj_val temp;

        for (unsigned int i = 0; i < topicm.record.size(); i++)
        {
            temp["id"]       = topicm.record[i].topicid;
            temp["parentid"] = topicm.record[i].parentid;
            temp["value"]    = topicm.record[i].title;
            client.val["list"].push(temp);
        }
```

#### åœ¨HTMLæ¨¡æ¿ä¸­ä½¿ç”¨

```HTML
<%c for(auto &a:obj["infos"].as_array()){ %>
<tr>
  <td><%c echo<<a["userid"].to_string(); %></td>
  <td><%c echo<<a["nickname"].to_string(); %></td>
  <td><%c echo<<a["name"].to_string(); %></td>
  <td><%c if(a["isopen"].to_int()==1){ %>å¯ç”¨<%c }else{ %>å…³é—­<%c } %></td>
  <td><a href="/superadmin/edituser?userid=<%c echo<<a["userid"].to_string(); %>">ç¼–è¾‘</a> | <a href="/superadmin/deleteuser?userid=<%c echo<<a["userid"].to_string(); %>" onclick="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ');">åˆ é™¤</a></td>
</tr>
<%c } %>
```


ä¸»è¦åº”ç”¨åœ¨å¤æ‚å¯¹è±¡äº¤æ¢ç¨‹åºï¼Œå¦‚æœä¸æ˜¯å¯ä»¥ä½¿ç”¨C++ å†…ç½®å¯¹è±¡æˆ–STLåº“æ–¹å¼ã€‚


### ORMä»‹ç»

paozhuæ¡†æ¶å†…ç½®ORMå¯¹è±¡ï¼Œç›®å‰è‡ªå·±åˆ†æMySQLåè®®ï¼Œæ–¹ä¾¿å’ŒORMæ•´åˆï¼Œè€Œä¸”æ”¯æŒåç¨‹æ¨¡å¼ï¼Œè¿™ä¸ªå®˜æ–¹æ²¡æœ‰æ”¯æŒã€‚


é…ç½®æ–‡ä»¶ä½ç½® `conf/orm.conf`

```
[default]
type=main
host=127.0.0.1
port=3306
dbname=hello_world
user=benchmarkdbuser
password=benchmarkdbpass
pretable=
maxpool=5
dbtype=mysql
#ssl=ON

type=second
host=127.0.0.1
port=3306
dbname=hello_world
user=benchmarkdbuser
password=benchmarkdbpass
pretable=
maxpool=20
dbtype=mysql
#ssl=ON
```

### ORM é…ç½®


`type` ä¸ºç±»å‹ å°±æ˜¯ä¸»ä»åˆ†ç¦»ï¼Œä»¥åå¯ä»¥å¼€å‘ç¼“å­˜åŒæ­¥ï¼Œç›®å‰å…ˆä¸»ä»ã€‚host `127.0.0.1` å¡«æœ¬åœ°çš„åœ°å€ï¼ŒMySQLå¿…é¡»å¤§äºç­‰äº8ç‰ˆæœ¬ï¼Œå› ä¸ºMySQL9ä¸æ”¯æŒæ—§çš„è®¤è¯äº†ï¼Œ
`pretable` æ˜¯è¡¨å‰ç¼€ï¼Œæœ‰æ—¶å€™åªæœ‰ä¸€ä¸ªæ•°æ®åº“æƒé™å¯ä»¥ä¸€ä¸ªæ•°æ®åº“æ”¾å¤šä¸ªä¸šåŠ¡ã€‚
`dbtype` ç›®å‰æ”¯æŒMySQLã€‚
`ssl` å¯ä»¥æ‰“å¼€ï¼Œç‰¹åˆ«æ˜¯è¿œç¨‹è¿æ¥æ—¶å€™ï¼Œå¯ç”¨åŠ å¯†è¿æ¥ã€‚æœ¬åœ°çš„ä¸ä¼šå¯ç”¨sslè¿æ¥ã€‚

### ORM ä½¿ç”¨å…¥é—¨

æ¡†æ¶ç›®å‰æ”¯æŒæ•°æ®åº“åˆ°æ–‡ä»¶æ–¹å¼ï¼Œè¿™æ ·ä¿®æ”¹æ•°æ®åº“å¯ä»¥é‡æ–°ç”ŸæˆORMæ–‡ä»¶ã€‚
ç¼–è¯‘æˆåŠŸå

```
# ./bin/paozhu_cli 

paozhu_cli(1495,0x7ff85ac38fc0) malloc: nano zone abandoned due to inability to reserve vm space.
  model ï½œ view | viewtocpp | control   
 Welcome to use cli to manage your MVC filesã€‚
(m)model (v)view (f)viewtocpp or (c)control , (j)son ,x or q to exit[input m|v|f|c|j|]:
```

è¾“å…¥ m é€‰æ‹©ç”ŸæˆORMæ¨¡å‹æ–‡ä»¶

```

paozhu_cli(1495,0x7ff85ac38fc0) malloc: nano zone abandoned due to inability to reserve vm space.
  model ï½œ view | viewtocpp | control   
 Welcome to use cli to manage your MVC filesã€‚
(m)model (v)view (f)viewtocpp or (c)control , (j)son ,x or q to exit[input m|v|f|c|j|]:m   
 ğŸ„ current path: /Users/hzq/paozhu
 1 hello_world
 3 paozhu_docs
 5 cppcms
select db index:
```

è¾“å…¥ 1 é€‰æ‹© hello_world æ•°æ®åº“ç”Ÿæˆæ–‡ä»¶ã€‚

```
paozhu_cli(1495,0x7ff85ac38fc0) malloc: nano zone abandoned due to inability to reserve vm space.
  model ï½œ view | viewtocpp | control   
 Welcome to use cli to manage your MVC filesã€‚
(m)model (v)view (f)viewtocpp or (c)control , (j)son ,x or q to exit[input m|v|f|c|j|]:m
 ğŸ„ current path: /Users/hzq/paozhu
 1 hello_world
 3 paozhu_docs
 5 cppcms
select db index:1
show tables;
create fortune table to models ğŸš—
 create table metainfo file: /Users/hzq/paozhu/orm/include/fortunebase.h
create world table to models ğŸš—
 create table metainfo file: /Users/hzq/paozhu/orm/include/worldbase.h
(m)model (v)view (f)viewtocpp or (c)control , (j)son ,x or q to exit[input m|v|f|c|j|]:x
```

è¾“å…¥ x é€€å‡º

```
å¯ä»¥çœ‹åˆ° /Users/hzq/paozhu/orm ç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶
orm
â”œâ”€â”€ include
â”‚   â”œâ”€â”€ fortune_mysql.h
â”‚   â”œâ”€â”€ fortunebase.h
â”‚   â”œâ”€â”€ world_mysql.h
â”‚   â””â”€â”€ worldbase.h
â”œâ”€â”€ orm.h
â”‚
models
â”œâ”€â”€ Fortune.cpp
â”œâ”€â”€ World.cpp
â””â”€â”€ include
    â”œâ”€â”€ Fortune.h
    â””â”€â”€ World.h
```

ORMç›®å½•æ˜¯å®ä½“æ–‡ä»¶ï¼Œä¸¤ä¸ªæ–‡ä»¶ä¸€ä¸ªæ˜¯mysqlè¿æ¥å±‚mysqlç»“å°¾ï¼Œä¸€ä¸ªæ˜¯æ•°æ®è¡¨å®ä½“æ˜ å°„base.hç»“å°¾ã€‚
æˆ‘ä»¬å…¶å®æ˜¯æ“ä½œmodelsç›®å½•ä¸‹ORMæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶ä¸€ä¸ªcppä¸€ä¸ªhæ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼Œ
ä½†æ˜¯åªç”Ÿæˆä¸€æ¬¡ï¼Œæœ‰äº†ä¸ä¼šè¦†ç›–ï¼Œå› ä¸ºçœŸæ­£ä¸šåŠ¡ç³»ç»Ÿå¯ä»¥è‡ªå·±åŠ ä¸šåŠ¡ä»£ç åœ¨é‡Œé¢ã€‚

æ¯”å¦‚
auto myworld = orm::World();
å°±æ˜¯ models ç›®å½•ä¸‹ World.h
è¿™ä¸ªæ˜¯é»˜è®¤æ•°æ®åº“ï¼Œæ¯”å¦‚è‡ªå¸¦cmsæ¼”ç¤º
auto users = orm::cms::Sysuser();

ormæ˜¯å‘½åç©ºé—´ï¼Œä¸»è¦æ˜¯ç»™ORMç”¨
cmsæ˜¯orm.confæ•°æ®åº“é…ç½®æ ‡ç­¾ï¼Œä¹Ÿæ˜¯ç”Ÿæˆçš„cmså‘½åç©ºé—´ï¼Œæ–¹ä¾¿éš”ç¦»å’Œè½¬æ¢æ•°æ®åº“ï¼Œå¦‚æœæ˜¯[default]å¯ä»¥çœç•¥defaut.

### ORMè®¾è®¡åŸç†

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Œå…¶å®ä¹Ÿæ˜¯paozhuæ¡†æ¶ç›®å‰æ¯”å…¶å®ƒæ¡†æ¶éå¸¸æœ‰ç‰¹è‰²çš„è®¾è®¡ã€‚
1. ä¸€ä¸ªæ•°æ®åº“å¯ä»¥æœ‰å¤šä¸ªè¿æ¥ï¼Œè¿™æ ·æˆ‘ä»¬ä¸çŸ¥é“ä½¿ç”¨é‚£ä¸ªè¿æ¥ã€‚
1. æ•°æ®åº“åå­—å¯èƒ½å¾ˆé•¿ï¼Œåƒäº‘ä¸»æœºå¯èƒ½è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå‡ åä¸ªå­—ç¬¦é•¿çš„æ•°æ®åº“åï¼Œç”šè‡³æœ‰ä¸‹åˆ’çº¿çš„ã€‚
1. å¯ä»¥ä¸ªæ€§æ ‡ç­¾ï¼Œè¿™æ ·æ•°æ®åº“æ˜¯ä»€ä¹ˆåä¸é‡è¦äº†ã€‚
1. æˆ‘ä»¬ç”¨æ¥åšå‘½åç©ºé—´éš”ç¦»è¡¨å¯¹è±¡ï¼Œè¿™æ ·å¾ˆå¤šæ•°æ®åº“ç”Ÿæˆçš„C++ç±»ä¸ä¼šå†²çªã€‚

æ‰€ä»¥`orm::cms::Sysuser();`ä½¿ç”¨cmséš”ç¦»äº†`sysuser`è¡¨å®ä½“C++ç±»ï¼Œä¸ä¼šä¸å…¶å®ƒæ•°æ®åº“åŒåè¡¨æœ‰å†²çªã€‚
æ¯”å¦‚`orm::erp::Sysuser();` erpæ˜¯erpæ•°æ®åº“æ ‡ç­¾ï¼Œä»–çš„æ•°æ®åº“æ˜¯ä»€ä¹ˆåä¸é‡è¦ï¼Œ
å°±æ˜¯åŒæ ·æœ‰`sysuser`è¡¨ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚

ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œå°±æ˜¯ä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œä¸€ä¸ªå•ä½“æœåŠ¡å™¨ç¨‹åºï¼Œå¯ä»¥æœ‰å¾ˆå¤šæ•°æ®åº“ï¼Œè€Œä¸”ä»–ä»¬è¡¨åå¯ä»¥æœ‰é‡åã€‚
ä»¥åå¯ä»¥æœ‰ä¸åŒæ•°æ®åº“ï¼Œæ¯”å¦‚MySQL PGç­‰ï¼Œä»–ä»¬å¯ä»¥åˆ†å¸ƒåœ¨å…¶å®ƒæœºå™¨ä¸Šã€‚
ä»–ä»¬å¯ä»¥æ··åˆé›†ç¾¤ï¼Œå•ä½“æœåŠ¡å™¨ç¨‹åºä¹Ÿå¯ä»¥é›†ç¾¤ï¼Œå› ä¸ºå†…ç½®äº†è¯»å†™åˆ†ç¦»ï¼Œå†™æœåŠ¡å™¨å¯ä»¥åŒä¸€ä¸ªï¼Œ
æŸ¥è¯¢å¯ä»¥å›ºå®šæˆ–åŠ¨æ€åˆ†é…æ•°æ®åº“æœåŠ¡å™¨,æ¡†æ¶å¯ä»¥é€‚åˆå¤§ä¸šåŠ¡ç³»ç»Ÿã€‚
ç›®å‰çœ‹ä¸€ä¸ªæœåŠ¡å™¨é›†æˆæ•°æ®åº“å’Œä¸šåŠ¡ç¨‹åºä¸ºä¸»ã€‚


### ORMä½¿ç”¨ä¾‹å­


è¡¨æ¨¡å‹æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡å¾ˆé‡è¦

- data     æ˜¯å•ä¸ªè¡¨æ•°æ®ç»“æ„æ˜ å°„
- record   ä¸€ä¸ªstd::vectoræ•°ç»„

è¡¨æ•°æ®ç»“æ„

```C++
struct meta{
 unsigned  int  id = 0; 
 int  randomnumber = 0;  
} data;

std::vector<worldbase::meta> record;
```

#### åç¨‹æ–¹å¼ä½¿ç”¨ORM

```C++
//@urlpath(null,queries)
asio::awaitable<std::string> techempowerqueries(std::shared_ptr<httppeer> peer)
{
    peer->type("application/json; charset=UTF-8");
    peer->set_header("Date", get_gmttime());

    unsigned int get_num = peer->get["queries"].to_int();
    if (get_num == 0)
    {
        get_num = 1;
    }
    else if (get_num > 500)
    {
        get_num = 500;
    }
    auto myworld = orm::World();
    myworld.record.reserve(get_num);
    myworld.lock_conn();
    for (unsigned int i = 0; i < get_num; i++)
    {
        myworld.wheresql.clear();
        unsigned int rd_num = rand_range(1, 10000);
        myworld.where("id", rd_num);
        co_await myworld.async_fetch_append();
    }
    myworld.unlock_conn();
    peer->output = myworld.to_json();
    co_return "";
}
```

- `orm::World();` æ˜¯ORMçš„è¡¨æ¨¡å‹ï¼Œé»˜è®¤è¿æ¥ï¼Œæ‰€ä»¥ä¸ç”¨defaul
- `myworld.lock_conn();` å°±æ˜¯å›ºå®šä¸€ä¸ªè¿æ¥ï¼Œå› ä¸ºä½¿ç”¨ORMè¿æ¥æ± æ–¹å¼,ä¼šè½®è®­ä½¿ç”¨è¿æ¥ã€‚
- `myworld.record.reserve(get_num);` æ‰©å®¹è¿™ä¸ªç†Ÿæ‚‰STLçš„çŸ¥é“ã€‚
- `myworld.wheresql.clear();` æ¨èä½¿`myworld.clearWhere();`æ–¹å¼æ¸…é™¤æ¡ä»¶ã€‚
- `myworld.where("id", rd_num);` åŠ ä¸€ä¸ªæ¡ä»¶ã€‚
- `co_await myworld.async_fetch_append();` æ˜¯é«˜çº§ç”¨æ³•ï¼Œä¼šé™„åŠ æ•°æ®åˆ°recordå¯¹è±¡ä¸Šã€‚ä¸€èˆ¬ä½¿ç”¨`co_await myworld.async_fetch();` ä¼šæ¸…é™¤recordå¯¹è±¡ï¼Œç„¶åé‡æ–°èµ‹å€¼ã€‚


`peer->output = myworld.to_json();` ç›´æ¥è¾“å‡ºJSONåˆ°æµè§ˆå™¨ã€‚



#### åŒæ­¥ä½¿ç”¨ORM

æ­£å¸¸ä¸šåŠ¡ä»£ç åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œå°±æ˜¯ä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªå¾ˆç»å…¸æ–¹å¼ã€‚

```C++
//@urlpath(admin_islogin,admin/addtopic)
std::string admin_addtopic(std::shared_ptr<httppeer> peer)
{
    httppeer &client = peer->get_peer();
    try
    {
        auto topicm = orm::cms::Topic();
        topicm.where("userid", client.session["userid"].to_int()).asc("parentid").fetch();

        client.val["list"].set_array();
        obj_val temp;

        for (unsigned int i = 0; i < topicm.record.size(); i++)
        {
            temp["id"]       = topicm.record[i].topicid;
            temp["parentid"] = topicm.record[i].parentid;
            temp["value"]    = topicm.record[i].title;
            client.val["list"].push(temp);
        }
    }
    catch (std::exception &e)
    {
        client.val["code"] = 1;
    }

    peer->view("admin/addtopic");
    return "";
}
```

`httppeer &client = peer->get_peer();` å¼•ç”¨è¿æ¥å¯¹è±¡

`auto topicm = orm::cms::Topic();`  äº§ç”Ÿä¸€ä¸ªORMæ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹æºæ–‡ä»¶åœ¨modelsç›®å½•ä¸‹é¢,Topicå°±æ˜¯æ•°æ®åº“è¡¨åï¼Œå¦‚æœè®¾ç½®å‰ç¼€é‚£ä¹ˆæ¡†æ¶ä¼šè‡ªåŠ¨å»é™¤ï¼Œ`topicm.where` æ·»åŠ æŸ¥è¯¢æ¡ä»¶ï¼Œ`asc("parentid").fetch()` æŒ‰å‡åº`parentid`æŸ¥è¯¢ï¼Œ`.fetch()`å‘å‡ºæŸ¥è¯¢å‘½ä»¤ã€‚

#### åˆ†é¡µä½¿ç”¨

å¦‚æœä¸æƒ³è¦é‚£ä¹ˆå¤šæ•°æ®å¯ä»¥åˆ†é¡µå–å‡ºï¼Œç‰¹åˆ«æ˜¯ç½‘ç»œä¸šåŠ¡ï¼Œéœ€è¦å ç”¨å¸¦å®½æˆ–cpuèµ„æºï¼Œå¹³æ—¶æœ€å¥½æŒ‰éœ€ä½¿ç”¨`.select("fieldname1,fieldname2")` å–å‡ºå­—æ®µæ•°æ®ï¼Œä½¿ç”¨`.limit(pos,offset)`é™å®šèŒƒå›´ã€‚

ä½¿ç”¨`.page(page, 10, 5)`å·²ç»è‡ªåŠ¨æ·»åŠ äº†`.limit(pos,offset)`é™å®šèŒƒå›´ï¼Œåªè¦ä¼ å…¥`page`é¡µç ã€‚


```C++
auto [bar_min, bar_max, current_page, total_page] = artmodel.page(page, 10, 5);

client.val["pageinfo"].set_object();
client.val["pageinfo"]["min"]     = bar_min;
client.val["pageinfo"]["max"]     = bar_max;
client.val["pageinfo"]["current"] = current_page;
client.val["pageinfo"]["total"]   = total_page;
```

`.page(page, 10, 5)` è¿”å›å››ä¸ªæ•°å€¼ï¼Œ`bar_min` `bar_max`ç”±ä¼ å…¥5å†³å®šèŒƒå›´ï¼Œ
å°±æ˜¯å‰å2é¡µçª—å£ï¼Œæ¯é¡µ10ä¸ªï¼Œ


### C++ç”Ÿäº§ç¯å¢ƒæ•…éšœæ’æŸ¥

æ¡†æ¶ä¼šéš”1åˆ†é’Ÿå·¦å³æ£€æŸ¥ `log` ç›®å½•æ˜¯å¦æœ‰`restart_server`æ–‡ä»¶

å¦‚æœæˆ‘ä»¬éœ€è¦å–ç°åœ¨çº¿ç¨‹æ ˆæ ·å“ï¼Œå¯ä»¥ `touch log/restart_server` è¿™æ ·å¯ä»¥è®©è¿›ç¨‹é‡å¯

å¯ä»¥ä½¿ç”¨`pstree -aup` æŸ¥çœ‹è¿›ç¨‹æƒ…å†µ

å¦‚æœå·²ç»å–æ ·ï¼Œæˆ‘å‘½éœ€è¦åˆ†æè¿›ç¨‹æ ˆæƒ…å†µ

éœ€è¦å®‰è£…gdb coredumpctl

æ ¸å¿ƒcoredumpæŸ¥çœ‹

```
coredumpctl list
coredumpctl info
```

ç›´æ¥åœ¨çº¿çœ‹,1524æ˜¯ info æ˜¾ç¤ºçš„è¿›ç¨‹å·ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰`pstree -aup` çœ‹çš„

```
coredumpctl gdb 1524
```

btå¯ä»¥æŸ¥çœ‹

è¿›å»åæˆ‘ä»¬å¯ä»¥ä¿å­˜å‡ºæ¥çœ‹ï¼Œä¿å­˜åœ¨å½“å‰ç›®å‰ `thread_info.txt`æ–‡ä»¶ã€‚

```
set logging file thread_info.txt
set logging enabled on
thread apply all bt
set logging enabled off
```


æ ¸å¿ƒcoredumpä¸€èˆ¬åœ¨

```
/var/lib/systemd/coredump
```

å¦‚æœç¼–è¯‘ä½¿ç”¨-g é‚£ä¹ˆä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢æ ·å­ï¼Œä¸€èˆ¬ä¼šæ˜¾ç¤ºå„ç§çº¿ç¨‹ç›®å‰æ­£åœ¨å¹²ä»€ä¹ˆäº‹

```
Thread 17 (Thread 0x7fd9f16b9640 (LWP 10658)):
          #0  http::hash_objkey (key=&quot;data:image/php;base64,PD9waHAgJE8wME9PMD11cmxkZWNvZGUoIiU3OCUzNCU2My&quot;...) at /www/paozhu/vendor/httpserver/src/request.cpp:54
          #1  0x000000000060032f in http::OBJ_VALUE::operator[] (this=0x7fd9cc01e520, key=&quot;data:image/php;base64,PD9waHAgJE8wME9PMD11cmxkZWNvZGUoIiU3OCUzNCU2MyU2RiUyRiU3MCUzOSU3OSU3MSU2RSU2NCUyRCU2QyU3MiU2QiU2NCU2NyU1RiU&quot;...) at /www/paozhu/vendor/httpserver/src/request.cpp:315
          #2  0x00000000005a990c in http::httpparse::procssxformurlencoded (this=0x7fd9b400d370) at /www/paozhu/vendor/httpserver/src/http_parse.cpp:389
          #3  0x00000000005b1bfa in http::httpparse::process (this=0x7fd9b400d370, buffer=0x2e223c0 &quot;POST /public/static/lib/webuploader/0.1.5/server/preview.php HTTP/1.1\r\nHost: www. paozhu.org\r\nUser-Agent: Mozilla/5.0 AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0\r\nAccept-Encoding: gzip, deflate&quot;..., buffersize=964) at /www/paozhu/vendor/httpserver/src/http_parse.cpp:2823
          
```